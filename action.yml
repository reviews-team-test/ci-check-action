name: 'Dbus Api Security Check'
description: 'Dbus Api Security Check'
inputs:
  reviewers:
    description: 'reviewers'
    required: true
    default: ckux

runs:
  using: "composite"
  steps:
    - name: Set up Clang
      uses: egor-tensin/setup-clang@v1
      with:
        version: latest
        platform: x64
    - name: install tools
      shell: bash
      run: |
        sudo apt install python3-pip golang -y
        sudo pip3 install clang
    - name: start check
      shell: bash
      run: |
        commit_info='
        {
            "repo_name": "${{github.repository}}",
            "branch": "${{github.ref_name}}",
            "committer": "${{github.actor}}",
            "commit_event": "${{github.server_url}}/${{github.repository}}/pull/${{github.event.pull_request.number}}",
            "commit_hash": "${{github.sha}}",
            "commit_event_id": "${{github.event.pull_request.number}}",
            "jenkins_url": "${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}}",
            "email": "test@test.com"
        }'
        cp $GITHUB_ACTION_PATH . -r
        python3 dbusapi-check/main.py --source_directory="." --commit_info_str="${commit_info}" || true
        sed -i 's/passed/unpassed/g' result.json || true
    - name: get specified property result
      id: repository_type
      uses: ActionsTools/read-json-action@main
      with:
        file_path: "result.json"
        prop_path: "scan_result"
    - name: Publish reports
      id: artifact-upload-step
      if: steps.repository_type.outputs.value == 'unpassed'
      uses: actions/upload-artifact@v4
      with:
        name: dbusApi-check-report
        path: dbus_check.log
    - if: steps.repository_type.outputs.value == 'unpassed'
      shell: bash
      run: |
        logMsg1='''
        <details>
          <summary>详情</summary>
        
        ```ruby
        '''
        logMsg2='''
        ``` 
        </details>
        '''
        resultInfoMsg=$(cat dbus_check.log)
        detailUrl="https://github.com/reviews-team-test/ci-check-action/blob/dbusapi-check/README.md"
        logMsgHead="> [!WARNING]\n> [[DBus参数检查]]($detailUrl)\n- 检查不通过"
        echo -e "${logMsgHead}${logMsg1}${resultInfoMsg}${logMsg2}" | tee comment.txt
    - name: post check
      if: steps.repository_type.outputs.value == 'unpassed'
      uses: reviews-team-test/ci-check-action@post-check
      with:
        comment-file: comment.txt
        reviewers: ${{inputs.reviewers}}